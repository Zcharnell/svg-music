<!DOCTYPE html>
<!--[if IE 8]>         <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--><html> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>SVG Music Visualizer</title>
  <meta name="keywords" content="" />
  <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" /> -->
  <style>
    body {
      margin:0;
      padding:0;
      overflow-x: hidden;
    }
    #svg1 {
      overflow:hidden;
    }
    #file-area {
      position: absolute;
      top: 0;
      width: 100%;
      background-color: #FFF;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div id="svg-area">
    <div id="file-area">
      <input type='file' id='fileUpload' onChange='changeAudio()'>
      <audio id='audioIn' src='banksstwo.wav'></audio>
      <button type="button" id="play-button">Play</button>
      <!-- For setting how many previous frequencies should be used to average out the current frequency -->
      <!-- <input type="range" id="smooth-slider" onChange="smoothSliderChange()"> -->
    </div>

    <svg width="1000" height="600" id="svg1" style="background-color: rgb(28,39,51)">
      <!-- <circle cx="20" cy="20" r="20" fill="green" />
      <circle cx="70" cy="70" r="20" fill="purple" />
      <rect x="110" y="110" height="30" width="30" fill="blue" />
      <rect x="160" y="160" height="30" width="30" fill="red" /> -->
    </svg>
  </div>
<script>
  var svgEle = document.getElementById("svg1");

  var width = document.body.clientWidth;
  var height = window.innerHeight;
  svgEle.setAttribute('width',width);
  svgEle.setAttribute('height',height);
  
  // var i = 0;
  // setInterval(function(){
  //   i += 50;
  //   createShape();
  // },25);
  // var j = 525;
  // setInterval(function(){
  //  j += 50;
  //  createShape();
  // },25);

  function createShape() {
    var shape = getRandomShape();
    svgEle.appendChild(shape);
    var shapei = 1;
    var shapeOpacityInterval = setInterval(function(){
      shapei -= 0.01;
      shape.setAttribute("style","opacity:"+shapei);
      if(shapei <= 0) {
        svgEle.removeChild(shape);
        clearInterval(shapeOpacityInterval);
      }
    },50)
  }

  function getRandomShape() {
    var rand = Math.floor(Math.random()*1);
    switch(rand) {
      case 0:
        var circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circle.setAttributeNS(null, "cx", i%width);
        circle.setAttributeNS(null, "cy", i%height);
        circle.setAttributeNS(null, "r", 15);
        circle.setAttributeNS(null, "fill", getRandomColor());
        return circle;
      case 1:
        var rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttributeNS(null, "x", i%width-15);
        rect.setAttributeNS(null, "y", i%height-15);
        rect.setAttributeNS(null, "height", 30);
        rect.setAttributeNS(null, "width", 30);
        rect.setAttributeNS(null, "fill", getRandomColor());
        return rect;
    }
  }

  function getRandomColor() {
    var rand = Math.floor(Math.random()*5);
    switch(rand) {
      case 0:
        return 'yellow';
      case 1:
        return 'blue';
      case 2:
        return 'red';
      case 3:
        return 'green';
      case 4:
        return '#DDDDFF';
    }
  }

  function createNonrandomShape(x,y,radius) {
    if(!y) {
      y = height;
    }
    var shape = document.createElementNS("http://www.w3.org/2000/svg","circle");
        shape.setAttributeNS(null, "cx", x);
        shape.setAttributeNS(null, "cy", y);
        shape.setAttributeNS(null, "r", radius);
        shape.setAttributeNS(null, "fill", "blue");
    svgEle.appendChild(shape);
    return shape;
    // var shapei = 1;
    // var shapeOpacityInterval = setInterval(function(){
    //   shapei -= 0.01;
    //   shape.setAttribute("style","opacity:"+shapei);
    //   if(shapei <= 0) {
    //     svgEle.removeChild(shape);
    //     clearInterval(shapeOpacityInterval);
    //   }
    // },50)
  }





  //Audio
  var visual = null;
  var shapes = [];
  var fftSize = 256;
  var lastFrequency = [[]];
  var numberLastFrequencies = 10;
  var minNumberLastFrequencies = 5;
  var maxNumberLastFrequencies = 10;
  var highestFrequency = 0;
  var audio = document.getElementById('audioIn');
  // document.getElementById('smooth-slider').value = numberLastFrequencies;
  // document.getElementById('smooth-slider').min = minNumberLastFrequencies;
  // document.getElementById('smooth-slider').max = maxNumberLastFrequencies;

  function changeAudio() {
    if(visual) {
      visual.stop();
    }
    document.getElementById('audioIn').src = document.getElementById('fileUpload').files[0].name;
    initLastFrequencyArrays();
    // document.getElementById('fileUpload').value = '';
  }

  function smoothSliderChange() {
    var sliderValue = parseInt(document.getElementById('smooth-slider').value);
    numberLastFrequencies = sliderValue;
    console.log(sliderValue,numberLastFrequencies);
  }
  
  function initLastFrequencyArrays() {
    for(var i=0; i<maxNumberLastFrequencies; i++) {
      lastFrequency[i] = [];
    }
  }

  function createShapes(count) {
    for(var i=0; i<count; i++) { 
      shapes[i] = createNonrandomShape(6+i*10,0,6);
    }
  }


  var renderers = {
    'visWindow': (function() {
        var initialized = false;
        var count;
        var maxHeight = height-20;

      var init = function(config) {
        count = config.count;
        createShapes(count);
        initLastFrequencyArrays();
        initialized = true;
      };

      var setLastFrequencies = function(index,frequency) {
        for(var i=maxNumberLastFrequencies-1; i>0; i--) {
          lastFrequency[i][index] = lastFrequency[i-1][index] || 0;
        }
        lastFrequency[0][index] = frequency;
      }

      var getLastFrequencies = function(index) {
        var sum = 0;
        for(var i=0; i<numberLastFrequencies; i++) {
          sum += lastFrequency[i][index] || 0;
        }
        return sum;
      }

      var renderFrame = function(frequencyData) {
        for(var i=0; i<count; i++) {
          //Get the average of the current frequency and the last n frequencies
          var curFrequency = (frequencyData[i] + getLastFrequencies(i)) / (numberLastFrequencies+1);
          //Set the y position of the shape to the value of the current frequency, based on the height of the window
          shapes[i].setAttribute('cy',height-(curFrequency/256*maxHeight));
          //Update the array of last frequencies
          setLastFrequencies(i,frequencyData[i]);
        }
      };


      return {
        init: init,
        isInitialized: function() {
          return initialized;
        },
        renderFrame: renderFrame
      }
    })()
  }

  function Visualization(config) {
    var audioStream,
      analyser,
      source,
      audioCtx,
      canvasCtx,
      frequencyData,
      running = false,
      renderer = config.renderer,
      width = config.width || 1200,
      height = config.height || 600,
      fftSize = 256;

    var init = function() {
      audioCtx = new AudioContext();
      analyser = audioCtx.createAnalyser();
      source =  audioCtx.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      analyser.fftSize = fftSize;
      frequencyData = new Uint8Array(analyser.frequencyBinCount);
      renderer.init({
        count: analyser.frequencyBinCount,
        width: width,
        height: height
      });
    };
    this.start = function() {
      audio.play();
      running = true;
      renderFrame();
    };
    this.stop = function() {
      running = false;
      audio.pause();
    };
    this.setRenderer = function(r) {
      if (!r.isInitialized()) {
        r.init({
          count: analyser.frequencyBinCount,
          width: width,
          height: height
        });
      } 
      renderer = r;
    };
    this.isPlaying = function() {
      return running;
    }

    var renderFrame = function() {
      analyser.getByteFrequencyData(frequencyData);
      renderer.renderFrame(frequencyData);
      if (running) {
        requestAnimationFrame(renderFrame);
      }
    };

    init();

  };

  var rend = renderers['visWindow'];
  visual = new Visualization({renderer: rend });
  visual.setRenderer(rend);

  document.getElementById("play-button").onclick = (function() {
    if (visual.isPlaying() && !audio.paused) {
      visual.stop();
    } else {
      visual.start();
    }
  });
</script>
</body>
</html>